# API de Validaci√≥n de C√©dulas Uruguayas

> **‚ö†Ô∏è ACTUALIZACI√ìN CR√çTICA 13/08/2025 - SOLUCI√ìN MEF Y NUEVA VULNERABILIDAD ANV**:
>
> **‚úÖ‚ùå SOLUCI√ìN MEF CON PROBLEMA OPERACIONAL**:
> - **MEF**: Vulnerabilidad eliminada mediante remoci√≥n del endpoint de autocompletado
> - **Consecuencia**: Todos los formularios MEF que depend√≠an del autocompletado ahora est√°n rotos
> - **Estado**: Seguro pero no funcional - usuarios deben ingresar datos manualmente
> - **Impacto**: P√©rdida de conveniencia y eficiencia en tr√°mites gubernamentales
>
> **üÜò NUEVA VULNERABILIDAD CR√çTICA DETECTADA**:
> - **ANV**: Aplicaci√≥n m√≥vil oficial expone nombres completos, apellidos y fecha de nacimiento por autocompletado de c√©dula
> - La app est√° disponible en Apple Store y Google Play Store para todos los ciudadanos
> - Cualquier persona puede descargar la aplicaci√≥n y acceder a datos personales de otros ciudadanos
> - **Sin autenticaci√≥n**: La aplicaci√≥n no requiere verificaci√≥n de identidad para mostrar datos sensibles
> - **Contexto sensible**: Exposici√≥n de datos en tr√°mites de vivienda social
>
> **üö® ESTADO ACTUAL DE VULNERABILIDADES GUBERNAMENTALES**:
> - **MEF**: ‚úÖ **VULNERABILIDAD SOLUCIONADA** - Endpoint removido, pero ‚ùå **FORMULARIOS ROTOS** - Autocompletado no funciona
> - **AIN**: Vulnerabilidad considerada solucionada ha resurgido, autocompletado activo nuevamente
> - **CGN**: Formularios judiciales exponen informaci√≥n personal sin verificaci√≥n de autorizaci√≥n
> - **ANV**: **NUEVA** - Aplicaci√≥n m√≥vil oficial expone informaci√≥n personal completa sin autenticaci√≥n
> - **Impacto operacional**: Remoci√≥n del endpoint MEF rompi√≥ funcionalidad de autocompletado en formularios gubernamentales
> - **Sin verificaci√≥n de identidad**: Sistemas restantes no verifican si el tr√°mite se realiza para uno mismo o para terceros
> - **Crisis dual**: MEF ahora seguro pero no funcional, otros organismos funcionales pero vulnerables
>
> **üìä Estado cr√≠tico**: Soluci√≥n de seguridad MEF caus√≥ crisis operacional en formularios gubernamentales.

> **üìÖ ACTUALIZACI√ìN DE SEGURIDAD 07/08/2025**: 
> 
> **‚ö†Ô∏è VULNERABILIDAD MEF RESURGI√ì**:
> La vulnerabilidad en el formulario https://www.tramitesenlinea.mef.gub.uy/Apia/portal/tramite.jsp?id=2629 volvi√≥ a resurgir. El sistema de autenticaci√≥n implementado no verifica correctamente la autenticaci√≥n y permite el acceso an√≥nimo exponiendo:
> - **Fecha de nacimiento completa** 
> - **Nombre completo** de cualquier ciudadano
> 
> **‚ö†Ô∏è VULNERABILIDAD AIN RESURGI√ì**:
> La vulnerabilidad en el formulario https://tramites.ain.gub.uy que se consideraba solucionada ha vuelto a aparecer, exponiendo nuevamente:
> - **Primer nombre** del titular
> - **Primer apellido** del titular
> - **Autocompletado autom√°tico** sin autenticaci√≥n efectiva
> 
> **‚ö†Ô∏è VULNERABILIDAD CGN ACTIVA**:
> El formulario de devoluci√≥n de timbre judicial https://www.cgn.gub.uy ahora funciona pero con vulnerabilidades:
> - **Autocompletado no autorizado** en contexto judicial
> - **Exposici√≥n de datos** en procesos legales sensibles
> 
> **ÔøΩ PROBLEMA DE SEGURIDAD CR√çTICO**:
> - El sistema permite autocompletar datos personales sensibles con solo ingresar una c√©dula
> - No valida si el usuario est√° autenticado correctamente con el gobierno
> - No verifica si el tr√°mite se realiza para uno mismo o para terceros
> - Expone informaci√≥n personal sin autorizaci√≥n adecuada
> 
> **‚úÖ MEJORAS T√âCNICAS IMPLEMENTADAS**:
> - ‚úÖ **Extracci√≥n de datos mejorada**: Soporte para el nuevo formato de formularios AIN_FRM_GRAL_DATOS_PERSONALES
> - ‚úÖ **Informaci√≥n adicional**: Tipo de documento, pa√≠s emisor, y componentes individuales de nombres y apellidos
> - ‚úÖ **Manejo de errores optimizado**: Mensajes m√°s descriptivos y manejo espec√≠fico por tipo de error
> - ‚úÖ **Validaci√≥n mejorada**: Verificaci√≥n de formato de c√©dula antes del procesamiento
> - ‚úÖ **Compatibilidad dual**: Funciona con formatos antiguos y nuevos de formularios gubernamentales
> - ‚úÖ **Logging mejorado**: Mayor detalle en los logs para debugging y monitoreo
> 
> **üìä ESTADO ACTUAL DE SERVICIOS GUBERNAMENTALES**:
> - ‚úÖ‚ùå **Formulario MEF SOLUCIONADO PERO ROTO**: Vulnerabilidad eliminada mediante remoci√≥n del endpoint, pero formularios no funcionan
> - ‚ö†Ô∏è **Formulario AIN VULNERABILIDAD RESURGI√ì**: https://tramites.ain.gub.uy autocompletado de primer nombre y primer apellido activo nuevamente
> - ‚ùå **Formularios de Loter√≠a inoperativos**: Todos los formularios que requieren c√©dula permanecen fuera de servicio desde 31/07/2025
> - ‚ö†Ô∏è **Formulario CGN VULNERABLE**: Devoluci√≥n de timbre judicial funciona con autocompletado no autorizado
> - üÜò **Aplicaci√≥n ANV VULNERABILIDAD CR√çTICA**: App m√≥vil oficial expone nombres, apellidos y fecha de nacimiento por autocompletado
> 
> **üìä Estado cr√≠tico**: Soluci√≥n MEF cre√≥ crisis operacional - formularios seguros pero inutilizables. Otros servicios mantienen vulnerabilidades activas.
> 
> Ver [reporte completo actualizado](./SECURITY_VULNERABILITY.md) para detalles t√©cnicos.

## üìã Contexto de Seguridad P√∫blica

> ### ‚ö†Ô∏è **Informaci√≥n para Ciudadanos Uruguayos**
> 
> **Este proyecto surge del an√°lisis de seguridad en sistemas p√∫blicos debido a:**
> 
> üîç **Ausencia de programas de recompensas** por reportes de seguridad en entidades p√∫blicas  
> üîç **Falta de canales formales** para reportar vulnerabilidades en sistemas gubernamentales  
> üîç **Necesidad de transparencia** en el estado de la ciberseguridad p√∫blica  
> üîç **Importancia de la educaci√≥n ciudadana** sobre protecci√≥n de datos personales  
> 
> **üéØ Objetivo**: Informar sobre el estado de los sistemas inform√°ticos p√∫blicos y promover mejores pr√°cticas de seguridad en el manejo de informaci√≥n ciudadana.
>
> **üìã Este proyecto contribuye a:**
> - Generar conciencia sobre la importancia de la ciberseguridad p√∫blica
> - Documentar el estado actual de los sistemas gubernamentales
> - Promover la transparencia en la gesti√≥n de sistemas p√∫blicos
> - Educar sobre buenas pr√°cticas de protecci√≥n de datos
>
> Consulte el [**üìÑ Reporte de Vulnerabilidades**](./SECURITY_VULNERABILITY.md) para informaci√≥n t√©cnica detallada.

---

Una API RESTful construida con TypeScript y Express siguiendo los principios SOLID para validar c√©dulas de identidad uruguayas y consultar informaci√≥n a trav√©s del formulario oficial del MEF (Ministerio de Econom√≠a y Finanzas).

## üÜï Nuevas Caracter√≠sticas (Agosto 2025)

### üìã **Extracci√≥n de Datos Mejorada**
- **Tipo de documento**: Identifica si es C√©dula de Identidad, Pasaporte u Otro
- **Pa√≠s emisor**: Detecta el pa√≠s que emiti√≥ el documento (Uruguay, Argentina, etc.)
- **Componentes individuales**: Extrae primer nombre, segundo nombre, primer apellido, segundo apellido por separado
- **Compatibilidad dual**: Funciona con formatos antiguos y nuevos de formularios

### üîß **Mejoras T√©cnicas**
- **Validaci√≥n previa**: Verifica formato de c√©dula antes del procesamiento
- **Manejo de errores optimizado**: Mensajes espec√≠ficos por tipo de error
- **Logging avanzado**: Mayor detalle para debugging y monitoreo
- **Performance mejorado**: Tiempos de procesamiento optimizados
- **Configuraci√≥n validada**: Verificaci√≥n autom√°tica de configuraci√≥n del servicio

### üìä **Datos Adicionales Extra√≠dos**
```json
{
  "success": true,
  "data": {
    "persona": {
      "nombre": "EDELMA",
      "apellido": "de SOUZA", 
      "cedula": "14115499",
      "tipoDocumento": "C√©dula de Identidad",
      "paisEmisor": "URUGUAY",
      "primerNombre": "EDELMA",
      "primerApellido": "de SOUZA",
      "processingTime": 1250,
      "hasSession": true
    }
  }
}
```

## üì¶ Paquete NPM Disponible

**¬°Esta funcionalidad tambi√©n est√° disponible como paquete npm!**

```bash
# Instalar el paquete
npm install ci-validation

# Uso b√°sico
import { validateCIAndQuery } from 'ci-validation';
const result = await validateCIAndQuery('19119365');
console.log(result);
// Output (solo validaci√≥n local - servicios gubernamentales con vulnerabilidades):
// {        
//   "success": true,
//   "data": {
//     "ci": "19119365",
//     "isValid": true,
//     "normalizedCi": "19119365",
//     "info": "Validaci√≥n local √∫nicamente - Servicios gubernamentales presentan vulnerabilidades desde 07/08/2025"
//   }
// }
```

üîó **Enlaces del paquete**:
- **npm**: https://www.npmjs.com/package/ci-validation
- **Documentaci√≥n completa**: [NPM_README.md](./NPM_README.md)
- **Gu√≠a de publicaci√≥n**: [NPM_PUBLISHING.md](./NPM_PUBLISHING.md)

## üöÄ Caracter√≠sticas

- **üì¶ Paquete NPM**: Disponible como librer√≠a independiente para proyectos TypeScript/JavaScript
- **üîß CLI incluido**: Herramienta de l√≠nea de comandos para validaci√≥n r√°pida
- **Validaci√≥n de CI**: Valida el formato y d√≠gito verificador de c√©dulas uruguayas
- **Consulta de datos**: Obtiene informaci√≥n oficial a trav√©s del formulario del MEF
- **Arquitectura SOLID**: Implementa los 5 principios SOLID para c√≥digo mantenible
- **TypeScript**: Tipado est√°tico para mayor robustez
- **Express.js**: Framework web r√°pido y minimalista
- **Middlewares de seguridad**: CORS, Helmet, Rate Limiting
- **Listo para Vercel**: Configuraci√≥n optimizada para deployment

## üìã Principios SOLID Implementados

### S - Single Responsibility Principle (SRP)
- `CiValidator`: Solo se encarga de validar c√©dulas
- `CiService`: Solo maneja las consultas a la API externa
- `CiController`: Solo maneja las peticiones HTTP

### O - Open/Closed Principle (OCP)
- Interfaces extensibles para validadores y servicios
- Nuevos tipos de validaci√≥n pueden agregarse sin modificar c√≥digo existente

### L - Liskov Substitution Principle (LSP)
- Las implementaciones de interfaces pueden intercambiarse sin afectar el funcionamiento

### I - Interface Segregation Principle (ISP)
- Interfaces espec√≠ficas y peque√±as
- No hay dependencias en m√©todos no utilizados

### D - Dependency Inversion Principle (DIP)
- Dependencias por inyecci√≥n de dependencias
- C√≥digo de alto nivel no depende de implementaciones concretas

## üõ†Ô∏è Instalaci√≥n

### Como Paquete NPM (Recomendado)

```bash
# Instalar la librer√≠a
npm install ci-validation

# Uso b√°sico
import { validateCI, validateCIAndQuery } from 'ci-validation';

// Validaci√≥n simple
console.log(validateCI('19119365')); // true

// Validaci√≥n con consulta (servicios gubernamentales con disponibilidad limitada)
const result = await validateCIAndQuery('19119365');
console.log(result);
```

### Instalaci√≥n Global (CLI)

```bash
# Instalar globalmente para usar desde l√≠nea de comandos
npm install -g ci-validation

```bash
# Usar el CLI
ci-validate 19119365
ci-validate 19119365 --query  # Consulta a servicios gubernamentales (disponibilidad limitada)
```

### Clonar el Repositorio (Desarrollo)

```bash
# Clonar repositorio
git clone <url-del-repo>
cd ci-validation-api

# Instalar dependencias
npm install

# Modo desarrollo
npm run dev

# Construir para producci√≥n
npm run build

# Iniciar en producci√≥n
npm start
```

## üì° Endpoints

### GET /health
Verifica el estado de la API

**Respuesta:**
```json
{
  "status": "ok",
  "timestamp": "2025-07-30T12:00:00.000Z"
}
```

### POST /api/ci/validate
Valida una c√©dula de identidad uruguaya

**Request Body:**
```json
{
  "ci": "19119365"
}
```

**Respuesta exitosa:**
```json
{
  "success": true,
  "data": {
    "ci": "19119365",
    "isValid": true,
    "info": "Informaci√≥n obtenida del formulario oficial del MEF..."
  }
}
```

**Respuesta con error:**
```json
{
  "success": false,
  "error": "C√©dula inv√°lida: formato incorrecto"
}
```

### POST /api/ci/smi
Consulta informaci√≥n espec√≠fica de SMI (Sociedad de Medicina del Interior) por c√©dula

**Request Body:**
```json
{
  "ci": "19119365"
}
```

**Tambi√©n disponible como GET:**
```bash
GET /api/ci/smi?ci=19119365
```

**Respuesta exitosa (usuario registrado):**
```json
{
  "success": true,
  "data": {
    "success": true,
    "hasUser": true,
    "member": {
      "ci": "19119365",
      "status": "registered",
      "executionTime": 1250,
      "userData": {
        "perID": "12345",
        "perCI": "19119365",
        "perMail": "user@email.com",
        "domicTel": "099123456",
        "isValidUser": true
      }
    }
  },
  "timestamp": "2025-08-13T12:00:00.000Z",
  "executionTime": {
    "total": 1300,
    "validation": 5,
    "query": 1250
  }
}
```

**Respuesta exitosa (usuario no registrado):**
```json
{
  "success": true,
  "data": {
    "success": true,
    "hasUser": false,
    "error": "Usuario no registrado en SMI"
  },
  "timestamp": "2025-08-13T12:00:00.000Z",
  "executionTime": {
    "total": 800,
    "validation": 5,
    "query": 750
  }
}
```

**Respuesta con error:**
```json
{
  "success": false,
  "error": "C√©dula inv√°lida: formato incorrecto",
  "code": "INVALID_FORMAT"
}
```

### GET /api/ci/demo
Endpoint de demostraci√≥n con una c√©dula de ejemplo

### GET /demo
P√°gina web interactiva para probar la API

La p√°gina de demostraci√≥n incluye:
- **Interfaz amigable**: Formulario simple para ingresar c√©dulas
- **Validaci√≥n en tiempo real**: Feedback inmediato sobre errores de formato
- **Respuesta dual**: Muestra tanto la respuesta JSON como un resultado amigable
- **Persistencia en URL**: La c√©dula se mantiene en la URL al recargar
- **Ejemplos**: Botones para probar c√©dulas de ejemplo
- **Responsive**: Funciona en dispositivos m√≥viles y desktop
- **Indicadores visuales**: Animaciones y colores para success/error

**Caracter√≠sticas t√©cnicas:**
- Uso de Tailwind CSS para estilos
- JavaScript vanilla para m√°ximo rendimiento
- Font Awesome para iconos
- Manejo de errores robusto
- Validaci√≥n del lado cliente antes de enviar

## üß™ Testing

```bash
# Ejecutar tests
npm test

# Ejecutar linting
npm run lint

# Corregir problemas de linting
npm run lint:fix
```

## üöÄ Deployment en Vercel

1. Conecta tu repositorio con Vercel
2. Vercel detectar√° autom√°ticamente la configuraci√≥n
3. Las variables de entorno se configuran en el dashboard de Vercel

### Configuraci√≥n para Vercel

El proyecto est√° optimizado para deployment serverless en Vercel:

- **Funciones serverless**: Los endpoints est√°n en la carpeta `/api/`
- **Archivos est√°ticos**: La p√°gina demo est√° en `/public/`
- **Configuraci√≥n autom√°tica**: `vercel.json` maneja el routing
- **Build autom√°tico**: TypeScript se compila autom√°ticamente

### Estructura de Deployment

```
api/
‚îú‚îÄ‚îÄ index.ts          # Endpoint ra√≠z (GET /)
‚îú‚îÄ‚îÄ health.ts         # Health check (GET /health)
‚îú‚îÄ‚îÄ validate.ts       # Validaci√≥n (POST /api/ci/validate)
‚îú‚îÄ‚îÄ smi.ts           # Consulta SMI (POST /api/ci/smi)
‚îî‚îÄ‚îÄ demo.ts          # Demo API (GET /api/ci/demo)
public/
‚îî‚îÄ‚îÄ index.html       # P√°gina demo (GET /demo)
```

### URLs en Producci√≥n

- **API Root**: `https://ci-validation.vercel.app/`
- **Health Check**: `https://ci-validation.vercel.app/health`
- **Validaci√≥n**: `https://ci-validation.vercel.app/api/ci/validate`
- **Demo Page**: `https://ci-validation.vercel.app/demo`

### Variables de Entorno

- `NODE_ENV`: `production`
- `PORT`: Puerto del servidor (autom√°tico en Vercel)

#### Configuraci√≥n de Proxy SMI (Opcional)

Para usar un proxy externo para las consultas SMI (√∫til cuando no se puede acceder directamente a SMI):

- `SMI_PROXY`: URL completa del servidor proxy que tiene acceso a SMI (ej: `https://xxxxxx.com`)

**Ejemplo de configuraci√≥n en `.env`:**
```bash
# Usar proxy externo para SMI
SMI_PROXY=https://xxxx.com
```

> **Nota**: Cuando se configura `SMI_PROXY`, el servicio har√° peticiones a `{SMI_PROXY}/api/smi?ci=xxx` en lugar de conectar directamente a SMI.

#### Configuraci√≥n de Proxy (Opcional)

Para enrutar las peticiones HTTP a trav√©s de un servidor proxy, puedes usar cualquiera de estos m√©todos:

**M√©todo 1: URL completa (recomendado)**
- `PROXY`: URL completa del proxy (ej: `http://179.27.158.18:80`)

**M√©todo 2: Variables individuales (para compatibilidad)**
- `PROXY_HOST`: Direcci√≥n del servidor proxy (ej: `proxy.empresa.com`)
- `PROXY_PORT`: Puerto del proxy (ej: `8080`)
- `PROXY_PROTOCOL`: Protocolo del proxy (`http` o `https`, por defecto `http`)
- `PROXY_USERNAME`: Usuario para autenticaci√≥n del proxy (opcional)
- `PROXY_PASSWORD`: Contrase√±a para autenticaci√≥n del proxy (opcional)

**Ejemplos de configuraci√≥n en `.env`:**
```bash
# M√©todo simple (recomendado)
PROXY=http://179.27.158.18:80

# Con autenticaci√≥n
PROXY=http://usuario:contrase√±a@proxy.empresa.com:8080

# M√©todo alternativo (variables individuales)
PROXY_HOST=proxy.empresa.com
PROXY_PORT=8080
PROXY_PROTOCOL=http
PROXY_USERNAME=mi_usuario
PROXY_PASSWORD=mi_contrase√±a
```

> **Nota**: El soporte de proxy est√° disponible para todas las consultas a servicios externos (SMI, loter√≠a, etc.)

## üìÅ Estructura del Proyecto

```
src/
‚îú‚îÄ‚îÄ controllers/          # Controladores HTTP
‚îÇ   ‚îî‚îÄ‚îÄ CiController.ts
‚îú‚îÄ‚îÄ services/            # Servicios de negocio
‚îÇ   ‚îî‚îÄ‚îÄ CiService.ts
‚îú‚îÄ‚îÄ validators/          # Validadores
‚îÇ   ‚îî‚îÄ‚îÄ CiValidator.ts
‚îú‚îÄ‚îÄ interfaces/          # Definiciones de tipos
‚îÇ   ‚îú‚îÄ‚îÄ ICiValidator.ts
‚îÇ   ‚îú‚îÄ‚îÄ ICiService.ts
‚îÇ   ‚îî‚îÄ‚îÄ ApiResponse.ts
‚îú‚îÄ‚îÄ middleware/          # Middlewares personalizados
‚îÇ   ‚îî‚îÄ‚îÄ errorHandler.ts
‚îú‚îÄ‚îÄ routes/             # Definici√≥n de rutas
‚îÇ   ‚îî‚îÄ‚îÄ ciRoutes.ts
‚îú‚îÄ‚îÄ utils/              # Utilidades
‚îÇ   ‚îî‚îÄ‚îÄ dependencyContainer.ts
‚îî‚îÄ‚îÄ index.ts            # Punto de entrada
```

## üîí Seguridad

- **CORS**: Configurado para permitir requests desde dominios espec√≠ficos
- **Helmet**: Headers de seguridad autom√°ticos
- **Rate Limiting**: L√≠mite de requests por IP
- **Validaci√≥n de entrada**: Validaci√≥n estricta de datos de entrada

## üìù Algoritmo de Validaci√≥n de CI

La validaci√≥n sigue el algoritmo oficial uruguayo:
1. Verificar que tenga 7-8 d√≠gitos
2. Calcular d√≠gito verificador usando el algoritmo oficial
3. Comparar con el √∫ltimo d√≠gito de la c√©dula

## ü§ù Contribuci√≥n

1. Fork el proyecto
2. Crea una rama para tu feature (`git checkout -b feature/AmazingFeature`)
3. Commit tus cambios (`git commit -m 'Add some AmazingFeature'`)
4. Push a la rama (`git push origin feature/AmazingFeature`)
5. Abre un Pull Request

### üì¶ Publicar el Paquete NPM

Si tienes permisos de publicaci√≥n:

```bash
# Verificar build
npm run build

# Dry run
npm run publish:dry

# Publicar
npm run publish:npm

# O incrementar versi√≥n y publicar
npm version patch  # o minor/major
npm run publish:npm
```

Ver [gu√≠a completa de publicaci√≥n](./NPM_PUBLISHING.md) para m√°s detalles.

## üìÑ Licencia

Este proyecto est√° bajo la Licencia MIT. Ver el archivo `LICENSE` para m√°s detalles.

## üîó Enlaces √ötiles

### üìñ Documentaci√≥n T√©cnica
- [Documentaci√≥n de Express](https://expressjs.com/)
- [TypeScript Handbook](https://www.typescriptlang.org/docs/)
- [Principios SOLID](https://en.wikipedia.org/wiki/SOLID)
- [Vercel Documentation](https://vercel.com/docs)

### üì¶ Paquete NPM
- **[üìö Documentaci√≥n del Paquete NPM](./NPM_README.md)** - Gu√≠a completa de uso de la librer√≠a
- **[üöÄ Gu√≠a de Publicaci√≥n NPM](./NPM_PUBLISHING.md)** - Instrucciones para publicar actualizaciones
- **[npm Package](https://www.npmjs.com/package/ci-validation)** - P√°gina oficial del paquete

### ‚ö†Ô∏è Seguridad
- **[‚ö†Ô∏è Reporte de Vulnerabilidad de Seguridad](./SECURITY_VULNERABILITY.md)** - Informaci√≥n sobre la vulnerabilidad encontrada en servicios gubernamentales
- **[üîç Informe T√©cnico de Vulnerabilidad IDOR](./TECHNICAL_VULNERABILITY_REPORT.md)** - An√°lisis t√©cnico detallado de la vulnerabilidad
- **[üõ°Ô∏è Pol√≠tica de Seguridad y VDP](./SECURITY.md)** - Programa de Divulgaci√≥n Responsable de Vulnerabilidades
